<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Submitter-Voter Flow - Chord Diagram</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
        }
        .info {
            text-align: center;
            color: #666;
            margin-bottom: 20px;
            font-size: 14px;
        }
        .nav-menu {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        .nav-menu label {
            font-weight: 600;
            color: #333;
        }
        .nav-menu select {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            background-color: white;
            cursor: pointer;
            min-width: 300px;
        }
        #chord-container {
            width: 100%;
            display: flex;
            justify-content: center;
            margin: 20px 0;
        }
        #chord-diagram {
            max-width: 900px;
        }
        .controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .control-group label {
            font-weight: 600;
            color: #333;
        }
        .control-group select {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            background-color: white;
            cursor: pointer;
        }
        .tooltip {
            position: absolute;
            padding: 12px;
            background-color: rgba(0, 0, 0, 0.85);
            color: white;
            border-radius: 5px;
            font-size: 13px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 1000;
            max-width: 300px;
        }
        .legend {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 30px 0;
            flex-wrap: wrap;
            font-size: 14px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
        }
        .explanation {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #667eea;
        }
        .explanation h3 {
            margin-top: 0;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Submitter-Voter Flow Analysis</h1>
        <p class="info">Chord diagram showing ranking flows • Hover over arcs to see connections • Select a person to focus on their relationships</p>

        <div class="nav-menu">
            <label for="visualization-select">Jump to: </label>
            <select id="visualization-select" onchange="if(this.value) window.location.href=this.value">
                <option value="">Choose a visualization...</option>
                <option value="rainbow_songs.html">Bar Chart - Rankings with Error Bars</option>
                <option value="rainbow_songs_scatter.html">Scatterplot - Average vs Std Dev</option>
                <option value="rainbow_songs_heatmap.html">Heatmap - Individual Voter Rankings</option>
                <option value="rainbow_songs_boxplot.html">Box Plots - Distribution Analysis</option>
                <option value="rainbow_songs_correlation.html">Correlation Matrix - Voter Similarity</option>
                <option value="rainbow_songs_network.html">Network Graph - Voter Affinities</option>
                <option value="rainbow_songs_submitter_affinity.html">Submitter-Voter Affinity Analysis</option>
                <option value="rainbow_songs_submitter_chord.html">Submitter-Voter Flow - Chord Diagram</option>
            </select>
        </div>

        <div class="controls">
            <div class="control-group">
                <label for="person-select">Focus on:</label>
                <select id="person-select">
                    <option value="">Everyone</option>
                </select>
            </div>
        </div>

        <div class="explanation">
            <h3>How to Read This Diagram</h3>
            <p><strong>Each person appears once around the circle.</strong> The chord connections show:</p>
            <ul>
                <li><strong>Outgoing (submitter side):</strong> Songs they submitted → Rankings received from voters</li>
                <li><strong>Incoming (voter side):</strong> Rankings they gave → Songs submitted by others</li>
                <li><strong>Chord thickness:</strong> Proportional to the number of songs in that submitter-voter relationship</li>
                <li><strong>Chord color:</strong> Colored by the submitter (where the songs came from)</li>
            </ul>
            <p><em>Hover over any arc segment to highlight that person's relationships!</em></p>
        </div>

        <div id="chord-container">
            <svg id="chord-diagram"></svg>
        </div>

        <div class="tooltip" id="tooltip"></div>
    </div>

    <script>
        let affinityData = null;
        let focusedPerson = null;

        fetch('submitter_voter_affinity.json')
            .then(response => response.json())
            .then(data => {
                affinityData = data;
                populatePersonSelect();
                renderChord();
            });

        function populatePersonSelect() {
            const select = document.getElementById('person-select');
            const people = affinityData.submitters;

            people.forEach(person => {
                const option = document.createElement('option');
                option.value = person;
                option.textContent = person;
                select.appendChild(option);
            });

            select.addEventListener('change', (e) => {
                focusedPerson = e.target.value || null;
                renderChord();
            });
        }

        function renderChord() {
            if (!affinityData) return;

            const people = affinityData.submitters; // Same as voters
            const n = people.length;

            // Build matrix: matrix[i][j] = count of songs from submitter i ranked by voter j
            const matrix = Array(n).fill(0).map(() => Array(n).fill(0));

            people.forEach((submitter, i) => {
                people.forEach((voter, j) => {
                    const affinity = affinityData.affinities[submitter][voter];
                    if (affinity) {
                        matrix[i][j] = affinity.count;
                    }
                });
            });

            // Clear previous diagram
            d3.select('#chord-diagram').selectAll('*').remove();

            const width = 900;
            const height = 900;
            const outerRadius = Math.min(width, height) * 0.5 - 100;
            const innerRadius = outerRadius - 30;

            const svg = d3.select('#chord-diagram')
                .attr('width', width)
                .attr('height', height)
                .attr('viewBox', [-width / 2, -height / 2, width, height]);

            // Color scale for people
            const color = d3.scaleOrdinal()
                .domain(people)
                .range(d3.schemeSet3);

            // Create chord layout
            const chord = d3.chord()
                .padAngle(0.05)
                .sortSubgroups(d3.descending);

            const arc = d3.arc()
                .innerRadius(innerRadius)
                .outerRadius(outerRadius);

            const ribbon = d3.ribbon()
                .radius(innerRadius);

            const chords = chord(matrix);

            const tooltip = document.getElementById('tooltip');

            // Draw the ribbons (chords)
            const ribbons = svg.append('g')
                .selectAll('path')
                .data(chords)
                .join('path')
                .attr('d', ribbon)
                .attr('fill', d => color(people[d.source.index]))
                .attr('stroke', d => d3.rgb(color(people[d.source.index])).darker())
                .style('mix-blend-mode', 'multiply')
                .attr('opacity', d => {
                    if (!focusedPerson) return 0.67;
                    const submitter = people[d.source.index];
                    const voter = people[d.target.index];
                    return (submitter === focusedPerson || voter === focusedPerson) ? 0.8 : 0.15;
                })
                .on('mouseover', function(event, d) {
                    const submitter = people[d.source.index];
                    const voter = people[d.target.index];
                    const affinity = affinityData.affinities[submitter][voter];

                    d3.select(this)
                        .attr('opacity', 0.9)
                        .attr('stroke-width', 2);

                    tooltip.innerHTML = `
                        <strong>${submitter}</strong> (submitter)<br>
                        → <strong>${voter}</strong> (voter)<br>
                        <br>
                        ${affinity.count} song${affinity.count > 1 ? 's' : ''}<br>
                        Avg ranking: ${affinity.average}<br>
                        Range: ${affinity.min}-${affinity.max}
                    `;
                    tooltip.style.opacity = 1;
                    tooltip.style.left = (event.pageX + 10) + 'px';
                    tooltip.style.top = (event.pageY + 10) + 'px';
                })
                .on('mouseout', function(event, d) {
                    const opacity = (!focusedPerson) ? 0.67 :
                        (people[d.source.index] === focusedPerson || people[d.target.index] === focusedPerson) ? 0.8 : 0.15;

                    d3.select(this)
                        .attr('opacity', opacity)
                        .attr('stroke-width', 1);

                    tooltip.style.opacity = 0;
                });

            // Draw the arcs (groups)
            const group = svg.append('g')
                .selectAll('g')
                .data(chords.groups)
                .join('g');

            group.append('path')
                .attr('d', arc)
                .attr('fill', d => color(people[d.index]))
                .attr('stroke', d => d3.rgb(color(people[d.index])).darker())
                .attr('opacity', d => {
                    if (!focusedPerson) return 0.8;
                    return people[d.index] === focusedPerson ? 1 : 0.3;
                })
                .on('mouseover', function(event, d) {
                    const person = people[d.index];

                    // Highlight this arc
                    d3.select(this).attr('opacity', 1);

                    // Highlight related ribbons
                    ribbons.attr('opacity', chord => {
                        return (people[chord.source.index] === person || people[chord.target.index] === person) ? 0.8 : 0.15;
                    });

                    // Calculate stats for this person
                    let asSubmitter = 0;
                    let asVoter = 0;
                    people.forEach(other => {
                        if (affinityData.affinities[person][other]) {
                            asSubmitter += affinityData.affinities[person][other].count;
                        }
                        if (affinityData.affinities[other][person]) {
                            asVoter += affinityData.affinities[other][person].count;
                        }
                    });

                    tooltip.innerHTML = `
                        <strong>${person}</strong><br>
                        <br>
                        As submitter: ${asSubmitter} song${asSubmitter !== 1 ? 's' : ''}<br>
                        As voter: rated ${asVoter} song${asVoter !== 1 ? 's' : ''} from others
                    `;
                    tooltip.style.opacity = 1;
                    tooltip.style.left = (event.pageX + 10) + 'px';
                    tooltip.style.top = (event.pageY + 10) + 'px';
                })
                .on('mouseout', function(event, d) {
                    const opacity = (!focusedPerson) ? 0.8 :
                        (people[d.index] === focusedPerson) ? 1 : 0.3;

                    d3.select(this).attr('opacity', opacity);

                    if (!focusedPerson) {
                        ribbons.attr('opacity', 0.67);
                    } else {
                        ribbons.attr('opacity', chord => {
                            return (people[chord.source.index] === focusedPerson || people[chord.target.index] === focusedPerson) ? 0.8 : 0.15;
                        });
                    }

                    tooltip.style.opacity = 0;
                });

            // Add labels
            group.append('text')
                .each(d => { d.angle = (d.startAngle + d.endAngle) / 2; })
                .attr('dy', '.35em')
                .attr('transform', d => `
                    rotate(${(d.angle * 180 / Math.PI - 90)})
                    translate(${outerRadius + 20})
                    ${d.angle > Math.PI ? 'rotate(180)' : ''}
                `)
                .attr('text-anchor', d => d.angle > Math.PI ? 'end' : null)
                .attr('font-size', '14px')
                .attr('font-weight', d => {
                    return (!focusedPerson || people[d.index] === focusedPerson) ? 'bold' : 'normal';
                })
                .attr('fill', d => {
                    return (!focusedPerson || people[d.index] === focusedPerson) ? '#333' : '#999';
                })
                .text(d => people[d.index]);
        }
    </script>
</body>
</html>
